"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = traverse;

var _util = require("@glimmer/util");

var _visitorKeys = _interopRequireDefault(require("../v1/visitor-keys"));

var _errors = require("./errors");

var _path = _interopRequireDefault(require("./path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function getEnterFunction(handler) {
  if (typeof handler === 'function') {
    return handler;
  } else {
    return handler.enter;
  }
}

function getExitFunction(handler) {
  if (typeof handler === 'function') {
    return undefined;
  } else {
    return handler.exit;
  }
}

function getKeyHandler(handler, key) {
  let keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
  if (keyVisitor === undefined) return;
  let keyHandler = keyVisitor[key];

  if (keyHandler !== undefined) {
    return keyHandler;
  }

  return keyVisitor.All;
}

function getNodeHandler(visitor, nodeType) {
  if (nodeType === 'Template' || nodeType === 'Block') {
    if (visitor.Program) {
      if (false
      /* LOCAL_DEBUG */
      ) {
          false && !false && (0, _util.deprecate)(`The 'Program' visitor node is deprecated. Use 'Template' or 'Block' instead (node was '${nodeType}') `);
        }

      return visitor.Program;
    }
  }

  let handler = visitor[nodeType];

  if (handler !== undefined) {
    return handler;
  }

  return visitor.All;
}

function visitNode(visitor, path) {
  let {
    node,
    parent,
    parentKey
  } = path;
  let handler = getNodeHandler(visitor, node.type);
  let enter;
  let exit;

  if (handler !== undefined) {
    enter = getEnterFunction(handler);
    exit = getExitFunction(handler);
  }

  let result;

  if (enter !== undefined) {
    result = enter(node, path);
  }

  if (result !== undefined && result !== null) {
    if (JSON.stringify(node) === JSON.stringify(result)) {
      result = undefined;
    } else if (Array.isArray(result)) {
      visitArray(visitor, result, parent, parentKey);
      return result;
    } else {
      let path = new _path.default(result, parent, parentKey);
      return visitNode(visitor, path) || result;
    }
  }

  if (result === undefined) {
    let keys = _visitorKeys.default[node.type];

    for (let i = 0; i < keys.length; i++) {
      let key = keys[i]; // we know if it has child keys we can widen to a ParentNode

      visitKey(visitor, handler, path, key);
    }

    if (exit !== undefined) {
      result = exit(node, path);
    }
  }

  return result;
}

function get(node, key) {
  return node[key];
}

function set(node, key, value) {
  node[key] = value;
}

function visitKey(visitor, handler, path, key) {
  let {
    node
  } = path;
  let value = get(node, key);

  if (!value) {
    return;
  }

  let keyEnter;
  let keyExit;

  if (handler !== undefined) {
    let keyHandler = getKeyHandler(handler, key);

    if (keyHandler !== undefined) {
      keyEnter = getEnterFunction(keyHandler);
      keyExit = getExitFunction(keyHandler);
    }
  }

  if (keyEnter !== undefined) {
    if (keyEnter(node, key) !== undefined) {
      throw (0, _errors.cannotReplaceOrRemoveInKeyHandlerYet)(node, key);
    }
  }

  if (Array.isArray(value)) {
    visitArray(visitor, value, path, key);
  } else {
    let keyPath = new _path.default(value, path, key);
    let result = visitNode(visitor, keyPath);

    if (result !== undefined) {
      // TODO: dynamically check the results by having a table of
      // expected node types in value space, not just type space
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      assignKey(node, key, value, result);
    }
  }

  if (keyExit !== undefined) {
    if (keyExit(node, key) !== undefined) {
      throw (0, _errors.cannotReplaceOrRemoveInKeyHandlerYet)(node, key);
    }
  }
}

function visitArray(visitor, array, parent, parentKey) {
  for (let i = 0; i < array.length; i++) {
    let node = array[i];
    let path = new _path.default(node, parent, parentKey);
    let result = visitNode(visitor, path);

    if (result !== undefined) {
      i += spliceArray(array, i, result) - 1;
    }
  }
}

function assignKey(node, key, value, result) {
  if (result === null) {
    throw (0, _errors.cannotRemoveNode)(value, node, key);
  } else if (Array.isArray(result)) {
    if (result.length === 1) {
      set(node, key, result[0]);
    } else {
      if (result.length === 0) {
        throw (0, _errors.cannotRemoveNode)(value, node, key);
      } else {
        throw (0, _errors.cannotReplaceNode)(value, node, key);
      }
    }
  } else {
    set(node, key, result);
  }
}

function spliceArray(array, index, result) {
  if (result === null) {
    array.splice(index, 1);
    return 0;
  } else if (Array.isArray(result)) {
    array.splice(index, 1, ...result);
    return result.length;
  } else {
    array.splice(index, 1, result);
    return 1;
  }
}

function traverse(node, visitor) {
  let path = new _path.default(node);
  visitNode(visitor, path);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvdHJhdmVyc2FsL3RyYXZlcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFHQTs7QUFDQTs7QUFLQTs7OztBQVNBLFNBQUEsZ0JBQUEsQ0FBQSxPQUFBLEVBQ2dEO0FBRTlDLE1BQUksT0FBQSxPQUFBLEtBQUosVUFBQSxFQUFtQztBQUNqQyxXQUFBLE9BQUE7QUFERixHQUFBLE1BRU87QUFDTCxXQUFPLE9BQU8sQ0FBZCxLQUFBO0FBQ0Q7QUFDRjs7QUFRRCxTQUFBLGVBQUEsQ0FBQSxPQUFBLEVBQ2dEO0FBRTlDLE1BQUksT0FBQSxPQUFBLEtBQUosVUFBQSxFQUFtQztBQUNqQyxXQUFBLFNBQUE7QUFERixHQUFBLE1BRU87QUFDTCxXQUFPLE9BQU8sQ0FBZCxJQUFBO0FBQ0Q7QUFDRjs7QUFFRCxTQUFBLGFBQUEsQ0FBQSxPQUFBLEVBQUEsR0FBQSxFQUVRO0FBRU4sTUFBSSxVQUFVLEdBQUcsT0FBQSxPQUFBLEtBQUEsVUFBQSxHQUFnQyxPQUFPLENBQXZDLElBQUEsR0FBakIsU0FBQTtBQUNBLE1BQUksVUFBVSxLQUFkLFNBQUEsRUFBOEI7QUFFOUIsTUFBSSxVQUFVLEdBQUcsVUFBVSxDQUEzQixHQUEyQixDQUEzQjs7QUFDQSxNQUFJLFVBQVUsS0FBZCxTQUFBLEVBQThCO0FBQzVCLFdBQUEsVUFBQTtBQUNEOztBQUNELFNBQU8sVUFBVSxDQUFqQixHQUFBO0FBQ0Q7O0FBT0QsU0FBQSxjQUFBLENBQUEsT0FBQSxFQUFBLFFBQUEsRUFFcUI7QUFFbkIsTUFBSSxRQUFRLEtBQVIsVUFBQSxJQUEyQixRQUFRLEtBQXZDLE9BQUEsRUFBcUQ7QUFDbkQsUUFBSSxPQUFPLENBQVgsT0FBQSxFQUFxQjtBQUNuQixVQUFBO0FBQUE7QUFBQSxRQUFpQjtBQUFBLG1CQUFBLENBQUEsS0FBQSxJQUNmLHFCQUNFLDBGQUEwRixRQUY3RSxLQUNmLENBRGU7QUFJaEI7O0FBRUQsYUFBTyxPQUFPLENBQWQsT0FBQTtBQUNEO0FBQ0Y7O0FBRUQsTUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFyQixRQUFxQixDQUFyQjs7QUFDQSxNQUFJLE9BQU8sS0FBWCxTQUFBLEVBQTJCO0FBQ3pCLFdBQUEsT0FBQTtBQUNEOztBQUNELFNBQU8sT0FBTyxDQUFkLEdBQUE7QUFDRDs7QUFFRCxTQUFBLFNBQUEsQ0FBQSxPQUFBLEVBQUEsSUFBQSxFQUVxQjtBQUVuQixNQUFJO0FBQUEsSUFBQSxJQUFBO0FBQUEsSUFBQSxNQUFBO0FBQWdCLElBQUE7QUFBaEIsTUFBSixJQUFBO0FBRUEsTUFBSSxPQUFPLEdBQXFCLGNBQWMsQ0FBQSxPQUFBLEVBQVUsSUFBSSxDQUE1RCxJQUE4QyxDQUE5QztBQUNBLE1BQUEsS0FBQTtBQUNBLE1BQUEsSUFBQTs7QUFFQSxNQUFJLE9BQU8sS0FBWCxTQUFBLEVBQTJCO0FBQ3pCLElBQUEsS0FBSyxHQUFHLGdCQUFnQixDQUF4QixPQUF3QixDQUF4QjtBQUNBLElBQUEsSUFBSSxHQUFHLGVBQWUsQ0FBdEIsT0FBc0IsQ0FBdEI7QUFDRDs7QUFFRCxNQUFBLE1BQUE7O0FBQ0EsTUFBSSxLQUFLLEtBQVQsU0FBQSxFQUF5QjtBQUN2QixJQUFBLE1BQU0sR0FBRyxLQUFLLENBQUEsSUFBQSxFQUFkLElBQWMsQ0FBZDtBQUNEOztBQUVELE1BQUksTUFBTSxLQUFOLFNBQUEsSUFBd0IsTUFBTSxLQUFsQyxJQUFBLEVBQTZDO0FBQzNDLFFBQUksSUFBSSxDQUFKLFNBQUEsQ0FBQSxJQUFBLE1BQXlCLElBQUksQ0FBSixTQUFBLENBQTdCLE1BQTZCLENBQTdCLEVBQXFEO0FBQ25ELE1BQUEsTUFBTSxHQUFOLFNBQUE7QUFERixLQUFBLE1BRU8sSUFBSSxLQUFLLENBQUwsT0FBQSxDQUFKLE1BQUksQ0FBSixFQUEyQjtBQUNoQyxNQUFBLFVBQVUsQ0FBQSxPQUFBLEVBQUEsTUFBQSxFQUFBLE1BQUEsRUFBVixTQUFVLENBQVY7QUFDQSxhQUFBLE1BQUE7QUFGSyxLQUFBLE1BR0E7QUFDTCxVQUFJLElBQUksR0FBRyxJQUFBLGFBQUEsQ0FBQSxNQUFBLEVBQUEsTUFBQSxFQUFYLFNBQVcsQ0FBWDtBQUNBLGFBQU8sU0FBUyxDQUFBLE9BQUEsRUFBVCxJQUFTLENBQVQsSUFBUCxNQUFBO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJLE1BQU0sS0FBVixTQUFBLEVBQTBCO0FBQ3hCLFFBQUksSUFBSSxHQUFHLHFCQUFZLElBQUksQ0FBM0IsSUFBVyxDQUFYOztBQUVBLFNBQUssSUFBSSxDQUFDLEdBQVYsQ0FBQSxFQUFnQixDQUFDLEdBQUcsSUFBSSxDQUF4QixNQUFBLEVBQWlDLENBQWpDLEVBQUEsRUFBc0M7QUFDcEMsVUFBSSxHQUFHLEdBQUcsSUFBSSxDQURzQixDQUN0QixDQUFkLENBRG9DLENBRXBDOztBQUNBLE1BQUEsUUFBUSxDQUFBLE9BQUEsRUFBQSxPQUFBLEVBQUEsSUFBQSxFQUFSLEdBQVEsQ0FBUjtBQUNEOztBQUVELFFBQUksSUFBSSxLQUFSLFNBQUEsRUFBd0I7QUFDdEIsTUFBQSxNQUFNLEdBQUcsSUFBSSxDQUFBLElBQUEsRUFBYixJQUFhLENBQWI7QUFDRDtBQUNGOztBQUVELFNBQUEsTUFBQTtBQUNEOztBQUVELFNBQUEsR0FBQSxDQUFBLElBQUEsRUFBQSxHQUFBLEVBRXVDO0FBRXJDLFNBQVEsSUFBSSxDQUFaLEdBQVksQ0FBWjtBQUNEOztBQUVELFNBQUEsR0FBQSxDQUFBLElBQUEsRUFBQSxHQUFBLEVBQUEsS0FBQSxFQUFrRjtBQUNoRixFQUFBLElBQUksQ0FBSixHQUFJLENBQUosR0FBQSxLQUFBO0FBQ0Q7O0FBRUQsU0FBQSxRQUFBLENBQUEsT0FBQSxFQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsR0FBQSxFQUl1QztBQUVyQyxNQUFJO0FBQUUsSUFBQTtBQUFGLE1BQUosSUFBQTtBQUVBLE1BQUksS0FBSyxHQUFHLEdBQUcsQ0FBQSxJQUFBLEVBQWYsR0FBZSxDQUFmOztBQUNBLE1BQUksQ0FBSixLQUFBLEVBQVk7QUFDVjtBQUNEOztBQUVELE1BQUEsUUFBQTtBQUNBLE1BQUEsT0FBQTs7QUFFQSxNQUFJLE9BQU8sS0FBWCxTQUFBLEVBQTJCO0FBQ3pCLFFBQUksVUFBVSxHQUFHLGFBQWEsQ0FBQSxPQUFBLEVBQTlCLEdBQThCLENBQTlCOztBQUNBLFFBQUksVUFBVSxLQUFkLFNBQUEsRUFBOEI7QUFDNUIsTUFBQSxRQUFRLEdBQUcsZ0JBQWdCLENBQTNCLFVBQTJCLENBQTNCO0FBQ0EsTUFBQSxPQUFPLEdBQUcsZUFBZSxDQUF6QixVQUF5QixDQUF6QjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSSxRQUFRLEtBQVosU0FBQSxFQUE0QjtBQUMxQixRQUFJLFFBQVEsQ0FBQSxJQUFBLEVBQVIsR0FBUSxDQUFSLEtBQUosU0FBQSxFQUF1QztBQUNyQyxZQUFNLGtEQUFvQyxJQUFwQyxFQUFOLEdBQU0sQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSSxLQUFLLENBQUwsT0FBQSxDQUFKLEtBQUksQ0FBSixFQUEwQjtBQUN4QixJQUFBLFVBQVUsQ0FBQSxPQUFBLEVBQUEsS0FBQSxFQUFBLElBQUEsRUFBVixHQUFVLENBQVY7QUFERixHQUFBLE1BRU87QUFDTCxRQUFJLE9BQU8sR0FBRyxJQUFBLGFBQUEsQ0FBQSxLQUFBLEVBQUEsSUFBQSxFQUFkLEdBQWMsQ0FBZDtBQUNBLFFBQUksTUFBTSxHQUFHLFNBQVMsQ0FBQSxPQUFBLEVBQXRCLE9BQXNCLENBQXRCOztBQUNBLFFBQUksTUFBTSxLQUFWLFNBQUEsRUFBMEI7QUFDeEI7QUFDQTtBQUNBO0FBQ0EsTUFBQSxTQUFTLENBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQVQsTUFBUyxDQUFUO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJLE9BQU8sS0FBWCxTQUFBLEVBQTJCO0FBQ3pCLFFBQUksT0FBTyxDQUFBLElBQUEsRUFBUCxHQUFPLENBQVAsS0FBSixTQUFBLEVBQXNDO0FBQ3BDLFlBQU0sa0RBQW9DLElBQXBDLEVBQU4sR0FBTSxDQUFOO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFNBQUEsVUFBQSxDQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsTUFBQSxFQUFBLFNBQUEsRUFJMEI7QUFFeEIsT0FBSyxJQUFJLENBQUMsR0FBVixDQUFBLEVBQWdCLENBQUMsR0FBRyxLQUFLLENBQXpCLE1BQUEsRUFBa0MsQ0FBbEMsRUFBQSxFQUF1QztBQUNyQyxRQUFJLElBQUksR0FBRyxLQUFLLENBQWhCLENBQWdCLENBQWhCO0FBQ0EsUUFBSSxJQUFJLEdBQUcsSUFBQSxhQUFBLENBQUEsSUFBQSxFQUFBLE1BQUEsRUFBWCxTQUFXLENBQVg7QUFDQSxRQUFJLE1BQU0sR0FBRyxTQUFTLENBQUEsT0FBQSxFQUF0QixJQUFzQixDQUF0Qjs7QUFDQSxRQUFJLE1BQU0sS0FBVixTQUFBLEVBQTBCO0FBQ3hCLE1BQUEsQ0FBQyxJQUFJLFdBQVcsQ0FBQSxLQUFBLEVBQUEsQ0FBQSxFQUFYLE1BQVcsQ0FBWCxHQUFMLENBQUE7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsU0FBQSxTQUFBLENBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsTUFBQSxFQUk4QjtBQUU1QixNQUFJLE1BQU0sS0FBVixJQUFBLEVBQXFCO0FBQ25CLFVBQU0sOEJBQWdCLEtBQWhCLEVBQWdCLElBQWhCLEVBQU4sR0FBTSxDQUFOO0FBREYsR0FBQSxNQUVPLElBQUksS0FBSyxDQUFMLE9BQUEsQ0FBSixNQUFJLENBQUosRUFBMkI7QUFDaEMsUUFBSSxNQUFNLENBQU4sTUFBQSxLQUFKLENBQUEsRUFBeUI7QUFDdkIsTUFBQSxHQUFHLENBQUEsSUFBQSxFQUFBLEdBQUEsRUFBWSxNQUFNLENBQXJCLENBQXFCLENBQWxCLENBQUg7QUFERixLQUFBLE1BRU87QUFDTCxVQUFJLE1BQU0sQ0FBTixNQUFBLEtBQUosQ0FBQSxFQUF5QjtBQUN2QixjQUFNLDhCQUFnQixLQUFoQixFQUFnQixJQUFoQixFQUFOLEdBQU0sQ0FBTjtBQURGLE9BQUEsTUFFTztBQUNMLGNBQU0sK0JBQWlCLEtBQWpCLEVBQWlCLElBQWpCLEVBQU4sR0FBTSxDQUFOO0FBQ0Q7QUFDRjtBQVRJLEdBQUEsTUFVQTtBQUNMLElBQUEsR0FBRyxDQUFBLElBQUEsRUFBQSxHQUFBLEVBQUgsTUFBRyxDQUFIO0FBQ0Q7QUFDRjs7QUFFRCxTQUFBLFdBQUEsQ0FBQSxLQUFBLEVBQUEsS0FBQSxFQUFBLE1BQUEsRUFBaUc7QUFDL0YsTUFBSSxNQUFNLEtBQVYsSUFBQSxFQUFxQjtBQUNuQixJQUFBLEtBQUssQ0FBTCxNQUFBLENBQUEsS0FBQSxFQUFBLENBQUE7QUFDQSxXQUFBLENBQUE7QUFGRixHQUFBLE1BR08sSUFBSSxLQUFLLENBQUwsT0FBQSxDQUFKLE1BQUksQ0FBSixFQUEyQjtBQUNoQyxJQUFBLEtBQUssQ0FBTCxNQUFBLENBQUEsS0FBQSxFQUFBLENBQUEsRUFBdUIsR0FBdkIsTUFBQTtBQUNBLFdBQU8sTUFBTSxDQUFiLE1BQUE7QUFGSyxHQUFBLE1BR0E7QUFDTCxJQUFBLEtBQUssQ0FBTCxNQUFBLENBQUEsS0FBQSxFQUFBLENBQUEsRUFBQSxNQUFBO0FBQ0EsV0FBQSxDQUFBO0FBQ0Q7QUFDRjs7QUFFYSxTQUFBLFFBQUEsQ0FBQSxJQUFBLEVBQUEsT0FBQSxFQUF5RDtBQUNyRSxNQUFJLElBQUksR0FBRyxJQUFBLGFBQUEsQ0FBWCxJQUFXLENBQVg7QUFDQSxFQUFBLFNBQVMsQ0FBQSxPQUFBLEVBQVQsSUFBUyxDQUFUO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMT0NBTF9ERUJVRyB9IGZyb20gJ0BnbGltbWVyL2xvY2FsLWRlYnVnLWZsYWdzJztcbmltcG9ydCB7IGRlcHJlY2F0ZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQgKiBhcyBBU1R2MSBmcm9tICcuLi92MS9hcGknO1xuaW1wb3J0IHZpc2l0b3JLZXlzLCB7IFZpc2l0b3JLZXksIFZpc2l0b3JLZXlzIH0gZnJvbSAnLi4vdjEvdmlzaXRvci1rZXlzJztcbmltcG9ydCB7XG4gIGNhbm5vdFJlbW92ZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VOb2RlLFxuICBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQsXG59IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCBXYWxrZXJQYXRoIGZyb20gJy4vcGF0aCc7XG5pbXBvcnQgeyBLZXlIYW5kbGVyLCBLZXlUcmF2ZXJzYWwsIE5vZGVIYW5kbGVyLCBOb2RlVHJhdmVyc2FsLCBOb2RlVmlzaXRvciB9IGZyb20gJy4vdmlzaXRvcic7XG5cbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb248TiBleHRlbmRzIEFTVHYxLk5vZGU+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+XG4pOiBOb2RlSGFuZGxlcjxOPiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb248TiBleHRlbmRzIEFTVHYxLk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBLZXlIYW5kbGVyPE4sIEs+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbjxOIGV4dGVuZHMgQVNUdjEuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+IHwgS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gaGFuZGxlcjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlci5lbnRlciBhcyBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz47XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1R2MS5Ob2RlPihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPlxuKTogTm9kZUhhbmRsZXI8Tj4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb248TiBleHRlbmRzIEFTVHYxLk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBLZXlIYW5kbGVyPE4sIEs+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1R2MS5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gfCBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IE5vZGVIYW5kbGVyPE4+IHwgS2V5SGFuZGxlcjxOLCBLPiB8IHVuZGVmaW5lZCB7XG4gIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGhhbmRsZXIuZXhpdCBhcyBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz47XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0S2V5SGFuZGxlcjxOIGV4dGVuZHMgQVNUdjEuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+LFxuICBrZXk6IEtcbik6IEtleVRyYXZlcnNhbDxOLCBLPiB8IEtleVRyYXZlcnNhbDxOLCBWaXNpdG9yS2V5PE4+PiB8IHVuZGVmaW5lZCB7XG4gIGxldCBrZXlWaXNpdG9yID0gdHlwZW9mIGhhbmRsZXIgIT09ICdmdW5jdGlvbicgPyBoYW5kbGVyLmtleXMgOiB1bmRlZmluZWQ7XG4gIGlmIChrZXlWaXNpdG9yID09PSB1bmRlZmluZWQpIHJldHVybjtcblxuICBsZXQga2V5SGFuZGxlciA9IGtleVZpc2l0b3Jba2V5XTtcbiAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBrZXlIYW5kbGVyIGFzIEtleVRyYXZlcnNhbDxOLCBLPjtcbiAgfVxuICByZXR1cm4ga2V5VmlzaXRvci5BbGw7XG59XG5cbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyPE4gZXh0ZW5kcyBBU1R2MS5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIG5vZGVUeXBlOiBOWyd0eXBlJ11cbik6IE5vZGVUcmF2ZXJzYWw8Tj47XG5mdW5jdGlvbiBnZXROb2RlSGFuZGxlcih2aXNpdG9yOiBOb2RlVmlzaXRvciwgbm9kZVR5cGU6ICdBbGwnKTogTm9kZVRyYXZlcnNhbDxBU1R2MS5Ob2RlPjtcbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyPE4gZXh0ZW5kcyBBU1R2MS5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIG5vZGVUeXBlOiBOWyd0eXBlJ11cbik6IE5vZGVUcmF2ZXJzYWw8QVNUdjEuTm9kZT4gfCB1bmRlZmluZWQge1xuICBpZiAobm9kZVR5cGUgPT09ICdUZW1wbGF0ZScgfHwgbm9kZVR5cGUgPT09ICdCbG9jaycpIHtcbiAgICBpZiAodmlzaXRvci5Qcm9ncmFtKSB7XG4gICAgICBpZiAoTE9DQUxfREVCVUcpIHtcbiAgICAgICAgZGVwcmVjYXRlKFxuICAgICAgICAgIGBUaGUgJ1Byb2dyYW0nIHZpc2l0b3Igbm9kZSBpcyBkZXByZWNhdGVkLiBVc2UgJ1RlbXBsYXRlJyBvciAnQmxvY2snIGluc3RlYWQgKG5vZGUgd2FzICcke25vZGVUeXBlfScpIGBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHZpc2l0b3IuUHJvZ3JhbSBhcyBOb2RlVHJhdmVyc2FsPEFTVHYxLk5vZGU+O1xuICAgIH1cbiAgfVxuXG4gIGxldCBoYW5kbGVyID0gdmlzaXRvcltub2RlVHlwZV07XG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gKGhhbmRsZXIgYXMgdW5rbm93bikgYXMgTm9kZVRyYXZlcnNhbDxBU1R2MS5Ob2RlPjtcbiAgfVxuICByZXR1cm4gdmlzaXRvci5BbGw7XG59XG5cbmZ1bmN0aW9uIHZpc2l0Tm9kZTxOIGV4dGVuZHMgQVNUdjEuTm9kZT4oXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBwYXRoOiBXYWxrZXJQYXRoPE4+XG4pOiBBU1R2MS5Ob2RlIHwgQVNUdjEuTm9kZVtdIHwgdW5kZWZpbmVkIHwgbnVsbCB8IHZvaWQge1xuICBsZXQgeyBub2RlLCBwYXJlbnQsIHBhcmVudEtleSB9ID0gcGF0aDtcblxuICBsZXQgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPiA9IGdldE5vZGVIYW5kbGVyKHZpc2l0b3IsIG5vZGUudHlwZSk7XG4gIGxldCBlbnRlcjtcbiAgbGV0IGV4aXQ7XG5cbiAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGVudGVyID0gZ2V0RW50ZXJGdW5jdGlvbihoYW5kbGVyKTtcbiAgICBleGl0ID0gZ2V0RXhpdEZ1bmN0aW9uKGhhbmRsZXIpO1xuICB9XG5cbiAgbGV0IHJlc3VsdDogQVNUdjEuTm9kZSB8IEFTVHYxLk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkO1xuICBpZiAoZW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlc3VsdCA9IGVudGVyKG5vZGUsIHBhdGgpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHJlc3VsdCwgcGFyZW50LCBwYXJlbnRLZXkpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhdGggPSBuZXcgV2Fsa2VyUGF0aChyZXN1bHQsIHBhcmVudCwgcGFyZW50S2V5KTtcbiAgICAgIHJldHVybiB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCkgfHwgcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlzID0gdmlzaXRvcktleXNbbm9kZS50eXBlXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGtleSA9IGtleXNbaV0gYXMgVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE47XG4gICAgICAvLyB3ZSBrbm93IGlmIGl0IGhhcyBjaGlsZCBrZXlzIHdlIGNhbiB3aWRlbiB0byBhIFBhcmVudE5vZGVcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIHBhdGgsIGtleSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzdWx0ID0gZXhpdChub2RlLCBwYXRoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBnZXQ8TiBleHRlbmRzIEFTVHYxLk5vZGU+KFxuICBub2RlOiBOLFxuICBrZXk6IFZpc2l0b3JLZXlzW05bJ3R5cGUnXV0gJiBrZXlvZiBOXG4pOiBBU1R2MS5Ob2RlIHwgQVNUdjEuTm9kZVtdIHtcbiAgcmV0dXJuIChub2RlW2tleV0gYXMgdW5rbm93bikgYXMgQVNUdjEuTm9kZSB8IEFTVHYxLk5vZGVbXTtcbn1cblxuZnVuY3Rpb24gc2V0PE4gZXh0ZW5kcyBBU1R2MS5Ob2RlLCBLIGV4dGVuZHMga2V5b2YgTj4obm9kZTogTiwga2V5OiBLLCB2YWx1ZTogTltLXSk6IHZvaWQge1xuICBub2RlW2tleV0gPSB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXk8TiBleHRlbmRzIEFTVHYxLk5vZGU+KFxuICB2aXNpdG9yOiBOb2RlVmlzaXRvcixcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPixcbiAgcGF0aDogV2Fsa2VyUGF0aDxOPixcbiAga2V5OiBWaXNpdG9yS2V5c1tOWyd0eXBlJ11dICYga2V5b2YgTlxuKSB7XG4gIGxldCB7IG5vZGUgfSA9IHBhdGg7XG5cbiAgbGV0IHZhbHVlID0gZ2V0KG5vZGUsIGtleSk7XG4gIGlmICghdmFsdWUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQga2V5RW50ZXI7XG4gIGxldCBrZXlFeGl0O1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5SGFuZGxlciA9IGdldEtleUhhbmRsZXIoaGFuZGxlciwga2V5KTtcbiAgICBpZiAoa2V5SGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBrZXlFbnRlciA9IGdldEVudGVyRnVuY3Rpb24oa2V5SGFuZGxlcik7XG4gICAgICBrZXlFeGl0ID0gZ2V0RXhpdEZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlFbnRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUVudGVyKG5vZGUsIGtleSkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgdmlzaXRBcnJheSh2aXNpdG9yLCB2YWx1ZSwgcGF0aCwga2V5KTtcbiAgfSBlbHNlIHtcbiAgICBsZXQga2V5UGF0aCA9IG5ldyBXYWxrZXJQYXRoKHZhbHVlLCBwYXRoLCBrZXkpO1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwga2V5UGF0aCk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAvLyBUT0RPOiBkeW5hbWljYWxseSBjaGVjayB0aGUgcmVzdWx0cyBieSBoYXZpbmcgYSB0YWJsZSBvZlxuICAgICAgLy8gZXhwZWN0ZWQgbm9kZSB0eXBlcyBpbiB2YWx1ZSBzcGFjZSwgbm90IGp1c3QgdHlwZSBzcGFjZVxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgIGFzc2lnbktleShub2RlLCBrZXksIHZhbHVlLCByZXN1bHQgYXMgYW55KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RXhpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUV4aXQobm9kZSwga2V5KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaXRBcnJheShcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGFycmF5OiBBU1R2MS5Ob2RlW10sXG4gIHBhcmVudDogV2Fsa2VyUGF0aDxBU1R2MS5Ob2RlPiB8IG51bGwsXG4gIHBhcmVudEtleTogc3RyaW5nIHwgbnVsbFxuKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgbm9kZSA9IGFycmF5W2ldO1xuICAgIGxldCBwYXRoID0gbmV3IFdhbGtlclBhdGgobm9kZSwgcGFyZW50LCBwYXJlbnRLZXkpO1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpICs9IHNwbGljZUFycmF5KGFycmF5LCBpLCByZXN1bHQpIC0gMTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzaWduS2V5PE4gZXh0ZW5kcyBBU1R2MS5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIG5vZGU6IE4sXG4gIGtleTogSyxcbiAgdmFsdWU6IEFTVHYxLk5vZGUsXG4gIHJlc3VsdDogTltLXSB8IFtOW0tdXSB8IG51bGxcbikge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZSh2YWx1ZSwgbm9kZSwga2V5KTtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgc2V0KG5vZGUsIGtleSwgcmVzdWx0WzBdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZSh2YWx1ZSwgbm9kZSwga2V5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VOb2RlKHZhbHVlLCBub2RlLCBrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBzZXQobm9kZSwga2V5LCByZXN1bHQpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNwbGljZUFycmF5KGFycmF5OiBBU1R2MS5Ob2RlW10sIGluZGV4OiBudW1iZXIsIHJlc3VsdDogQVNUdjEuTm9kZSB8IEFTVHYxLk5vZGVbXSB8IG51bGwpIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgcmV0dXJuIDA7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCAuLi5yZXN1bHQpO1xuICAgIHJldHVybiByZXN1bHQubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgcmVzdWx0KTtcbiAgICByZXR1cm4gMTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0cmF2ZXJzZShub2RlOiBBU1R2MS5Ob2RlLCB2aXNpdG9yOiBOb2RlVmlzaXRvcik6IHZvaWQge1xuICBsZXQgcGF0aCA9IG5ldyBXYWxrZXJQYXRoKG5vZGUpO1xuICB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9