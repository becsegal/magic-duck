"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createPrimitiveRef = createPrimitiveRef;
exports.createConstRef = createConstRef;
exports.createUnboundRef = createUnboundRef;
exports.createComputeRef = createComputeRef;
exports.createReadOnlyRef = createReadOnlyRef;
exports.isInvokableRef = isInvokableRef;
exports.createInvokableRef = createInvokableRef;
exports.isConstRef = isConstRef;
exports.isUpdatableRef = isUpdatableRef;
exports.valueForRef = valueForRef;
exports.updateRef = updateRef;
exports.childRefFor = childRefFor;
exports.childRefFromParts = childRefFromParts;
exports.createDebugAliasRef = exports.FALSE_REFERENCE = exports.TRUE_REFERENCE = exports.NULL_REFERENCE = exports.UNDEFINED_REFERENCE = exports.REFERENCE = void 0;

var _env = require("@glimmer/env");

var _globalContext = require("@glimmer/global-context");

var _util = require("@glimmer/util");

var _validator = require("@glimmer/validator");

var REFERENCE = (0, _util.symbol)('REFERENCE');
exports.REFERENCE = REFERENCE;

var ReferenceImpl = function ReferenceImpl(type) {
  this.tag = null;
  this.lastRevision = _validator.INITIAL;
  this.children = null;
  this.compute = null;
  this.update = null;
  this[REFERENCE] = type;
};

function createPrimitiveRef(value) {
  var ref = new ReferenceImpl(2
  /* Unbound */
  );
  ref.tag = _validator.CONSTANT_TAG;
  ref.lastValue = value;

  if (_env.DEBUG) {
    ref.debugLabel = String(value);
  }

  return ref;
}

var UNDEFINED_REFERENCE = createPrimitiveRef(undefined);
exports.UNDEFINED_REFERENCE = UNDEFINED_REFERENCE;
var NULL_REFERENCE = createPrimitiveRef(null);
exports.NULL_REFERENCE = NULL_REFERENCE;
var TRUE_REFERENCE = createPrimitiveRef(true);
exports.TRUE_REFERENCE = TRUE_REFERENCE;
var FALSE_REFERENCE = createPrimitiveRef(false);
exports.FALSE_REFERENCE = FALSE_REFERENCE;

function createConstRef(value, debugLabel) {
  var ref = new ReferenceImpl(0
  /* Constant */
  );
  ref.lastValue = value;
  ref.tag = _validator.CONSTANT_TAG;

  if (_env.DEBUG) {
    ref.debugLabel = debugLabel;
  }

  return ref;
}

function createUnboundRef(value, debugLabel) {
  var ref = new ReferenceImpl(2
  /* Unbound */
  );
  ref.lastValue = value;
  ref.tag = _validator.CONSTANT_TAG;

  if (_env.DEBUG) {
    ref.debugLabel = debugLabel;
  }

  return ref;
}

function createComputeRef(compute, update, debugLabel) {
  if (update === void 0) {
    update = null;
  }

  if (debugLabel === void 0) {
    debugLabel = 'unknown';
  }

  var ref = new ReferenceImpl(1
  /* Compute */
  );
  ref.compute = compute;
  ref.update = update;

  if (_env.DEBUG) {
    ref.debugLabel = "(result of a `" + debugLabel + "` helper)";
  }

  return ref;
}

function createReadOnlyRef(ref) {
  if (!isUpdatableRef(ref)) return ref;
  return createComputeRef(function () {
    return valueForRef(ref);
  }, null, ref.debugLabel);
}

function isInvokableRef(ref) {
  return ref[REFERENCE] === 3
  /* Invokable */
  ;
}

function createInvokableRef(inner) {
  var ref = createComputeRef(function () {
    return valueForRef(inner);
  }, function (value) {
    return updateRef(inner, value);
  });
  ref.debugLabel = inner.debugLabel;
  ref[REFERENCE] = 3
  /* Invokable */
  ;
  return ref;
}

function isConstRef(_ref) {
  var ref = _ref;
  return ref.tag === _validator.CONSTANT_TAG;
}

function isUpdatableRef(_ref) {
  var ref = _ref;
  return ref.update !== null;
}

function valueForRef(_ref) {
  var ref = _ref;
  var tag = ref.tag;

  if (tag === _validator.CONSTANT_TAG) {
    return ref.lastValue;
  }

  var lastRevision = ref.lastRevision;
  var lastValue;

  if (tag === null || !(0, _validator.validateTag)(tag, lastRevision)) {
    var compute = ref.compute;
    tag = ref.tag = (0, _validator.track)(function () {
      lastValue = ref.lastValue = compute();
    }, _env.DEBUG && ref.debugLabel);
    ref.lastRevision = (0, _validator.valueForTag)(tag);
  } else {
    lastValue = ref.lastValue;
  }

  (0, _validator.consumeTag)(tag);
  return lastValue;
}

function updateRef(_ref, value) {
  var ref = _ref;
  var update = ref.update;
  update(value);
}

function childRefFor(_parentRef, path) {
  var parentRef = _parentRef;
  var type = parentRef[REFERENCE];
  var children = parentRef.children;
  var child;

  if (children === null) {
    children = parentRef.children = new Map();
  } else {
    child = children.get(path);

    if (child !== undefined) {
      return child;
    }
  }

  if (type === 2
  /* Unbound */
  ) {
      var parent = valueForRef(parentRef);

      if ((0, _util.isDict)(parent)) {
        child = createUnboundRef(parent[path], _env.DEBUG && parentRef.debugLabel + "." + path);
      } else {
        child = UNDEFINED_REFERENCE;
      }
    } else {
    child = createComputeRef(function () {
      var parent = valueForRef(parentRef);

      if ((0, _util.isDict)(parent)) {
        return (0, _globalContext.getProp)(parent, path);
      }
    }, function (val) {
      var parent = valueForRef(parentRef);

      if ((0, _util.isDict)(parent)) {
        return (0, _globalContext.setProp)(parent, path, val);
      }
    });

    if (_env.DEBUG) {
      child.debugLabel = parentRef.debugLabel + "." + path;
    }
  }

  children.set(path, child);
  return child;
}

function childRefFromParts(root, parts) {
  var reference = root;

  for (var i = 0; i < parts.length; i++) {
    reference = childRefFor(reference, parts[i]);
  }

  return reference;
}

var createDebugAliasRef;
exports.createDebugAliasRef = createDebugAliasRef;

if (_env.DEBUG) {
  exports.createDebugAliasRef = createDebugAliasRef = function createDebugAliasRef(debugLabel, inner) {
    var update = isUpdatableRef(inner) ? function (value) {
      return updateRef(inner, value);
    } : null;
    var ref = createComputeRef(function () {
      return valueForRef(inner);
    }, update);
    ref[REFERENCE] = inner[REFERENCE];
    ref.debugLabel = debugLabel;
    return ref;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3JlZmVyZW5jZS9saWIvcmVmZXJlbmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBV08sSUFBTSxTQUFTLEdBQWtCLGtCQUFqQyxXQUFpQyxDQUFqQzs7O0lBd0JQLGEsR0FhRSxTQUFBLGFBQUEsQ0FBQSxJQUFBLEVBQStCO0FBWHhCLE9BQUEsR0FBQSxHQUFBLElBQUE7QUFDQSxPQUFBLFlBQUEsR0FBQSxrQkFBQTtBQUdBLE9BQUEsUUFBQSxHQUFBLElBQUE7QUFFQSxPQUFBLE9BQUEsR0FBQSxJQUFBO0FBQ0EsT0FBQSxNQUFBLEdBQUEsSUFBQTtBQUtMLE9BQUEsU0FBQSxJQUFBLElBQUE7OztBQUlFLFNBQUEsa0JBQUEsQ0FBQSxLQUFBLEVBQTJDO0FBQy9DLE1BQUksR0FBRyxHQUFHLElBQUEsYUFBQSxDQUFpQjtBQUFBO0FBQWpCLEdBQVY7QUFFQSxFQUFBLEdBQUcsQ0FBSCxHQUFBLEdBQUEsdUJBQUE7QUFDQSxFQUFBLEdBQUcsQ0FBSCxTQUFBLEdBQUEsS0FBQTs7QUFFQSxNQUFBLFVBQUEsRUFBVztBQUNULElBQUEsR0FBRyxDQUFILFVBQUEsR0FBaUIsTUFBTSxDQUF2QixLQUF1QixDQUF2QjtBQUNEOztBQUVELFNBQUEsR0FBQTtBQUNEOztBQUVNLElBQU0sbUJBQW1CLEdBQUcsa0JBQWtCLENBQTlDLFNBQThDLENBQTlDOztBQUNBLElBQU0sY0FBYyxHQUFHLGtCQUFrQixDQUF6QyxJQUF5QyxDQUF6Qzs7QUFDQSxJQUFNLGNBQWMsR0FBRyxrQkFBa0IsQ0FBekMsSUFBeUMsQ0FBekM7O0FBQ0EsSUFBTSxlQUFlLEdBQUcsa0JBQWtCLENBQTFDLEtBQTBDLENBQTFDOzs7QUFFRCxTQUFBLGNBQUEsQ0FBQSxLQUFBLEVBQUEsVUFBQSxFQUFtRTtBQUN2RSxNQUFJLEdBQUcsR0FBRyxJQUFBLGFBQUEsQ0FBaUI7QUFBQTtBQUFqQixHQUFWO0FBRUEsRUFBQSxHQUFHLENBQUgsU0FBQSxHQUFBLEtBQUE7QUFDQSxFQUFBLEdBQUcsQ0FBSCxHQUFBLEdBQUEsdUJBQUE7O0FBRUEsTUFBQSxVQUFBLEVBQVc7QUFDVCxJQUFBLEdBQUcsQ0FBSCxVQUFBLEdBQUEsVUFBQTtBQUNEOztBQUVELFNBQUEsR0FBQTtBQUNEOztBQUVLLFNBQUEsZ0JBQUEsQ0FBQSxLQUFBLEVBQUEsVUFBQSxFQUFxRTtBQUN6RSxNQUFJLEdBQUcsR0FBRyxJQUFBLGFBQUEsQ0FBaUI7QUFBQTtBQUFqQixHQUFWO0FBRUEsRUFBQSxHQUFHLENBQUgsU0FBQSxHQUFBLEtBQUE7QUFDQSxFQUFBLEdBQUcsQ0FBSCxHQUFBLEdBQUEsdUJBQUE7O0FBRUEsTUFBQSxVQUFBLEVBQVc7QUFDVCxJQUFBLEdBQUcsQ0FBSCxVQUFBLEdBQUEsVUFBQTtBQUNEOztBQUVELFNBQUEsR0FBQTtBQUNEOztBQUVLLFNBQUEsZ0JBQUEsQ0FBQSxPQUFBLEVBQUEsTUFBQSxFQUFBLFVBQUEsRUFHa0M7QUFBQSxNQUR0QyxNQUNzQyxLQUFBLEtBQUEsQ0FBQSxFQUFBO0FBRHRDLElBQUEsTUFDc0MsR0FIbEMsSUFFSjtBQUNzQzs7QUFBQSxNQUF0QyxVQUFzQyxLQUFBLEtBQUEsQ0FBQSxFQUFBO0FBQXRDLElBQUEsVUFBc0MsR0FIbEMsU0FHSjtBQUFzQzs7QUFFdEMsTUFBSSxHQUFHLEdBQUcsSUFBQSxhQUFBLENBQWlCO0FBQUE7QUFBakIsR0FBVjtBQUVBLEVBQUEsR0FBRyxDQUFILE9BQUEsR0FBQSxPQUFBO0FBQ0EsRUFBQSxHQUFHLENBQUgsTUFBQSxHQUFBLE1BQUE7O0FBRUEsTUFBQSxVQUFBLEVBQVc7QUFDVCxJQUFBLEdBQUcsQ0FBSCxVQUFBLEdBQUEsbUJBQUEsVUFBQSxHQUFBLFdBQUE7QUFDRDs7QUFFRCxTQUFBLEdBQUE7QUFDRDs7QUFFSyxTQUFBLGlCQUFBLENBQUEsR0FBQSxFQUEwQztBQUM5QyxNQUFJLENBQUMsY0FBYyxDQUFuQixHQUFtQixDQUFuQixFQUEwQixPQUFBLEdBQUE7QUFFMUIsU0FBTyxnQkFBZ0IsQ0FBQyxZQUFBO0FBQUEsV0FBTSxXQUFXLENBQWxCLEdBQWtCLENBQWpCO0FBQUQsR0FBQSxFQUFBLElBQUEsRUFBK0IsR0FBRyxDQUF6RCxVQUF1QixDQUF2QjtBQUNEOztBQUVLLFNBQUEsY0FBQSxDQUFBLEdBQUEsRUFBdUM7QUFDM0MsU0FBTyxHQUFHLENBQUgsU0FBRyxDQUFILEtBQWM7QUFBQTtBQUFyQjtBQUNEOztBQUVLLFNBQUEsa0JBQUEsQ0FBQSxLQUFBLEVBQTZDO0FBQ2pELE1BQUksR0FBRyxHQUFHLGdCQUFnQixDQUN4QixZQUFBO0FBQUEsV0FBTSxXQUFXLENBRE8sS0FDUCxDQUFqQjtBQUR3QixHQUFBLEVBRXZCLFVBQUQsS0FBQyxFQUFEO0FBQUEsV0FBVyxTQUFTLENBQUEsS0FBQSxFQUZ0QixLQUVzQixDQUFwQjtBQUZGLEdBQTBCLENBQTFCO0FBSUEsRUFBQSxHQUFHLENBQUgsVUFBQSxHQUFpQixLQUFLLENBQXRCLFVBQUE7QUFDQSxFQUFBLEdBQUcsQ0FBSCxTQUFHLENBQUgsR0FBYztBQUFBO0FBQWQ7QUFFQSxTQUFBLEdBQUE7QUFDRDs7QUFFSyxTQUFBLFVBQUEsQ0FBQSxJQUFBLEVBQW9DO0FBQ3hDLE1BQUksR0FBRyxHQUFQLElBQUE7QUFFQSxTQUFPLEdBQUcsQ0FBSCxHQUFBLEtBQVAsdUJBQUE7QUFDRDs7QUFFSyxTQUFBLGNBQUEsQ0FBQSxJQUFBLEVBQXdDO0FBQzVDLE1BQUksR0FBRyxHQUFQLElBQUE7QUFFQSxTQUFPLEdBQUcsQ0FBSCxNQUFBLEtBQVAsSUFBQTtBQUNEOztBQUVLLFNBQUEsV0FBQSxDQUFBLElBQUEsRUFBMkM7QUFDL0MsTUFBSSxHQUFHLEdBQVAsSUFBQTtBQUQrQyxNQUd6QyxHQUh5QyxHQUcvQyxHQUgrQyxDQUFBLEdBQUE7O0FBSy9DLE1BQUksR0FBRyxLQUFQLHVCQUFBLEVBQTBCO0FBQ3hCLFdBQU8sR0FBRyxDQUFWLFNBQUE7QUFDRDs7QUFQOEMsTUFTekMsWUFUeUMsR0FTL0MsR0FUK0MsQ0FBQSxZQUFBO0FBVS9DLE1BQUEsU0FBQTs7QUFFQSxNQUFJLEdBQUcsS0FBSCxJQUFBLElBQWdCLENBQUMsNEJBQVcsR0FBWCxFQUFyQixZQUFxQixDQUFyQixFQUFxRDtBQUFBLFFBQzdDLE9BRDZDLEdBQ25ELEdBRG1ELENBQUEsT0FBQTtBQUduRCxJQUFBLEdBQUcsR0FBRyxHQUFHLENBQUgsR0FBQSxHQUFVLHNCQUFNLFlBQUs7QUFDekIsTUFBQSxTQUFTLEdBQUcsR0FBRyxDQUFILFNBQUEsR0FBZ0IsT0FBNUIsRUFBQTtBQURtQixLQUFMLEVBRWIsY0FBUyxHQUFHLENBRmYsVUFBZ0IsQ0FBaEI7QUFJQSxJQUFBLEdBQUcsQ0FBSCxZQUFBLEdBQW1CLDRCQUFuQixHQUFtQixDQUFuQjtBQVBGLEdBQUEsTUFRTztBQUNMLElBQUEsU0FBUyxHQUFHLEdBQUcsQ0FBZixTQUFBO0FBQ0Q7O0FBRUQsNkJBQUEsR0FBQTtBQUVBLFNBQUEsU0FBQTtBQUNEOztBQUVLLFNBQUEsU0FBQSxDQUFBLElBQUEsRUFBQSxLQUFBLEVBQW1EO0FBQ3ZELE1BQUksR0FBRyxHQUFQLElBQUE7QUFFQSxNQUFJLE1BQU0sR0FBVSxHQUFHLENBQXZCLE1BQUE7QUFFQSxFQUFBLE1BQU0sQ0FBTixLQUFNLENBQU47QUFDRDs7QUFFSyxTQUFBLFdBQUEsQ0FBQSxVQUFBLEVBQUEsSUFBQSxFQUF5RDtBQUM3RCxNQUFJLFNBQVMsR0FBYixVQUFBO0FBRUEsTUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFwQixTQUFvQixDQUFwQjtBQUVBLE1BQUksUUFBUSxHQUFHLFNBQVMsQ0FBeEIsUUFBQTtBQUNBLE1BQUEsS0FBQTs7QUFFQSxNQUFJLFFBQVEsS0FBWixJQUFBLEVBQXVCO0FBQ3JCLElBQUEsUUFBUSxHQUFHLFNBQVMsQ0FBVCxRQUFBLEdBQXFCLElBQWhDLEdBQWdDLEVBQWhDO0FBREYsR0FBQSxNQUVPO0FBQ0wsSUFBQSxLQUFLLEdBQUcsUUFBUSxDQUFSLEdBQUEsQ0FBUixJQUFRLENBQVI7O0FBRUEsUUFBSSxLQUFLLEtBQVQsU0FBQSxFQUF5QjtBQUN2QixhQUFBLEtBQUE7QUFDRDtBQUNGOztBQUVELE1BQUksSUFBSSxLQUFBO0FBQUE7QUFBUixJQUFvQztBQUNsQyxVQUFJLE1BQU0sR0FBRyxXQUFXLENBQXhCLFNBQXdCLENBQXhCOztBQUVBLFVBQUksa0JBQUosTUFBSSxDQUFKLEVBQW9CO0FBQ2xCLFFBQUEsS0FBSyxHQUFHLGdCQUFnQixDQUNyQixNQUFrQyxDQURiLElBQ2EsQ0FEYixFQUV0QixjQUFZLFNBQVMsQ0FBaEIsVUFBTyxHQUFQLEdBQU8sR0FGZCxJQUF3QixDQUF4QjtBQURGLE9BQUEsTUFLTztBQUNMLFFBQUEsS0FBSyxHQUFMLG1CQUFBO0FBQ0Q7QUFWSCxLQUFBLE1BV087QUFDTCxJQUFBLEtBQUssR0FBRyxnQkFBZ0IsQ0FDdEIsWUFBSztBQUNILFVBQUksTUFBTSxHQUFHLFdBQVcsQ0FBeEIsU0FBd0IsQ0FBeEI7O0FBRUEsVUFBSSxrQkFBSixNQUFJLENBQUosRUFBb0I7QUFDbEIsZUFBTyw0QkFBTyxNQUFQLEVBQVAsSUFBTyxDQUFQO0FBQ0Q7QUFObUIsS0FBQSxFQVFyQixVQUFELEdBQUMsRUFBTztBQUNOLFVBQUksTUFBTSxHQUFHLFdBQVcsQ0FBeEIsU0FBd0IsQ0FBeEI7O0FBRUEsVUFBSSxrQkFBSixNQUFJLENBQUosRUFBb0I7QUFDbEIsZUFBTyw0QkFBTyxNQUFQLEVBQU8sSUFBUCxFQUFQLEdBQU8sQ0FBUDtBQUNEO0FBYkwsS0FBd0IsQ0FBeEI7O0FBaUJBLFFBQUEsVUFBQSxFQUFXO0FBQ1QsTUFBQSxLQUFLLENBQUwsVUFBQSxHQUFzQixTQUFTLENBQS9CLFVBQXNCLEdBQXRCLEdBQXNCLEdBQXRCLElBQUE7QUFDRDtBQUNGOztBQUVELEVBQUEsUUFBUSxDQUFSLEdBQUEsQ0FBQSxJQUFBLEVBQUEsS0FBQTtBQUVBLFNBQUEsS0FBQTtBQUNEOztBQUVLLFNBQUEsaUJBQUEsQ0FBQSxJQUFBLEVBQUEsS0FBQSxFQUE0RDtBQUNoRSxNQUFJLFNBQVMsR0FBYixJQUFBOztBQUVBLE9BQUssSUFBSSxDQUFDLEdBQVYsQ0FBQSxFQUFnQixDQUFDLEdBQUcsS0FBSyxDQUF6QixNQUFBLEVBQWtDLENBQWxDLEVBQUEsRUFBdUM7QUFDckMsSUFBQSxTQUFTLEdBQUcsV0FBVyxDQUFBLFNBQUEsRUFBWSxLQUFLLENBQXhDLENBQXdDLENBQWpCLENBQXZCO0FBQ0Q7O0FBRUQsU0FBQSxTQUFBO0FBQ0Q7O0FBRU0sSUFBQSxtQkFBQTs7O0FBRVAsSUFBQSxVQUFBLEVBQVc7QUFDVCxnQ0FBQSxtQkFBbUIsR0FBRyxTQUFBLG1CQUFBLENBQUEsVUFBQSxFQUFBLEtBQUEsRUFBeUM7QUFDN0QsUUFBSSxNQUFNLEdBQUcsY0FBYyxDQUFkLEtBQWMsQ0FBZCxHQUF5QixVQUFELEtBQUMsRUFBRDtBQUFBLGFBQW9CLFNBQVMsQ0FBQSxLQUFBLEVBQXJELEtBQXFELENBQTdCO0FBQXhCLEtBQUEsR0FBYixJQUFBO0FBQ0EsUUFBSSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsWUFBQTtBQUFBLGFBQU0sV0FBVyxDQUFsQixLQUFrQixDQUFqQjtBQUFELEtBQUEsRUFBMUIsTUFBMEIsQ0FBMUI7QUFFQSxJQUFBLEdBQUcsQ0FBSCxTQUFHLENBQUgsR0FBaUIsS0FBSyxDQUF0QixTQUFzQixDQUF0QjtBQUVBLElBQUEsR0FBRyxDQUFILFVBQUEsR0FBQSxVQUFBO0FBRUEsV0FBQSxHQUFBO0FBUkYsR0FBQTtBQVVEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnO1xuaW1wb3J0IHsgZ2V0UHJvcCwgc2V0UHJvcCB9IGZyb20gJ0BnbGltbWVyL2dsb2JhbC1jb250ZXh0JztcbmltcG9ydCB7IE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgZXhwZWN0LCBpc0RpY3QsIHN5bWJvbCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHtcbiAgQ09OU1RBTlRfVEFHLFxuICBjb25zdW1lVGFnLFxuICBJTklUSUFMLFxuICBSZXZpc2lvbixcbiAgVGFnLFxuICB0cmFjayxcbiAgdmFsaWRhdGVUYWcsXG4gIHZhbHVlRm9yVGFnLFxufSBmcm9tICdAZ2xpbW1lci92YWxpZGF0b3InO1xuXG5leHBvcnQgY29uc3QgUkVGRVJFTkNFOiB1bmlxdWUgc3ltYm9sID0gc3ltYm9sKCdSRUZFUkVOQ0UnKTtcblxuY29uc3QgZW51bSBSZWZlcmVuY2VUeXBlIHtcbiAgQ29uc3RhbnQsXG4gIENvbXB1dGUsXG4gIFVuYm91bmQsXG4gIEludm9rYWJsZSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWZlcmVuY2U8X1QgPSB1bmtub3duPiB7XG4gIFtSRUZFUkVOQ0VdOiBSZWZlcmVuY2VUeXBlO1xuICBkZWJ1Z0xhYmVsPzogc3RyaW5nO1xuICBjaGlsZHJlbjogbnVsbCB8IE1hcDxzdHJpbmcgfCBSZWZlcmVuY2UsIFJlZmVyZW5jZT47XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlZmVyZW5jZTtcblxuLy8vLy8vLy8vL1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlZmVyZW5jZUVudmlyb25tZW50IHtcbiAgZ2V0UHJvcChvYmo6IHVua25vd24sIHBhdGg6IHN0cmluZyk6IHVua25vd247XG4gIHNldFByb3Aob2JqOiB1bmtub3duLCBwYXRoOiBzdHJpbmcsIHZhbHVlOiB1bmtub3duKTogdW5rbm93bjtcbn1cblxuY2xhc3MgUmVmZXJlbmNlSW1wbDxUID0gdW5rbm93bj4gaW1wbGVtZW50cyBSZWZlcmVuY2Uge1xuICBbUkVGRVJFTkNFXTogUmVmZXJlbmNlVHlwZTtcbiAgcHVibGljIHRhZzogT3B0aW9uPFRhZz4gPSBudWxsO1xuICBwdWJsaWMgbGFzdFJldmlzaW9uOiBSZXZpc2lvbiA9IElOSVRJQUw7XG4gIHB1YmxpYyBsYXN0VmFsdWU/OiBUO1xuXG4gIHB1YmxpYyBjaGlsZHJlbjogT3B0aW9uPE1hcDxzdHJpbmcgfCBSZWZlcmVuY2UsIFJlZmVyZW5jZT4+ID0gbnVsbDtcblxuICBwdWJsaWMgY29tcHV0ZTogT3B0aW9uPCgpID0+IFQ+ID0gbnVsbDtcbiAgcHVibGljIHVwZGF0ZTogT3B0aW9uPCh2YWw6IFQpID0+IHZvaWQ+ID0gbnVsbDtcblxuICBwdWJsaWMgZGVidWdMYWJlbD86IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcih0eXBlOiBSZWZlcmVuY2VUeXBlKSB7XG4gICAgdGhpc1tSRUZFUkVOQ0VdID0gdHlwZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUHJpbWl0aXZlUmVmKHZhbHVlOiB1bmtub3duKTogUmVmZXJlbmNlIHtcbiAgbGV0IHJlZiA9IG5ldyBSZWZlcmVuY2VJbXBsKFJlZmVyZW5jZVR5cGUuVW5ib3VuZCk7XG5cbiAgcmVmLnRhZyA9IENPTlNUQU5UX1RBRztcbiAgcmVmLmxhc3RWYWx1ZSA9IHZhbHVlO1xuXG4gIGlmIChERUJVRykge1xuICAgIHJlZi5kZWJ1Z0xhYmVsID0gU3RyaW5nKHZhbHVlKTtcbiAgfVxuXG4gIHJldHVybiByZWY7XG59XG5cbmV4cG9ydCBjb25zdCBVTkRFRklORURfUkVGRVJFTkNFID0gY3JlYXRlUHJpbWl0aXZlUmVmKHVuZGVmaW5lZCk7XG5leHBvcnQgY29uc3QgTlVMTF9SRUZFUkVOQ0UgPSBjcmVhdGVQcmltaXRpdmVSZWYobnVsbCk7XG5leHBvcnQgY29uc3QgVFJVRV9SRUZFUkVOQ0UgPSBjcmVhdGVQcmltaXRpdmVSZWYodHJ1ZSk7XG5leHBvcnQgY29uc3QgRkFMU0VfUkVGRVJFTkNFID0gY3JlYXRlUHJpbWl0aXZlUmVmKGZhbHNlKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUNvbnN0UmVmKHZhbHVlOiB1bmtub3duLCBkZWJ1Z0xhYmVsOiBmYWxzZSB8IHN0cmluZyk6IFJlZmVyZW5jZSB7XG4gIGxldCByZWYgPSBuZXcgUmVmZXJlbmNlSW1wbChSZWZlcmVuY2VUeXBlLkNvbnN0YW50KTtcblxuICByZWYubGFzdFZhbHVlID0gdmFsdWU7XG4gIHJlZi50YWcgPSBDT05TVEFOVF9UQUc7XG5cbiAgaWYgKERFQlVHKSB7XG4gICAgcmVmLmRlYnVnTGFiZWwgPSBkZWJ1Z0xhYmVsIGFzIHN0cmluZztcbiAgfVxuXG4gIHJldHVybiByZWY7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVVbmJvdW5kUmVmKHZhbHVlOiB1bmtub3duLCBkZWJ1Z0xhYmVsOiBmYWxzZSB8IHN0cmluZyk6IFJlZmVyZW5jZSB7XG4gIGxldCByZWYgPSBuZXcgUmVmZXJlbmNlSW1wbChSZWZlcmVuY2VUeXBlLlVuYm91bmQpO1xuXG4gIHJlZi5sYXN0VmFsdWUgPSB2YWx1ZTtcbiAgcmVmLnRhZyA9IENPTlNUQU5UX1RBRztcblxuICBpZiAoREVCVUcpIHtcbiAgICByZWYuZGVidWdMYWJlbCA9IGRlYnVnTGFiZWwgYXMgc3RyaW5nO1xuICB9XG5cbiAgcmV0dXJuIHJlZjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUNvbXB1dGVSZWY8VCA9IHVua25vd24+KFxuICBjb21wdXRlOiAoKSA9PiBULFxuICB1cGRhdGU6IE9wdGlvbjwodmFsdWU6IFQpID0+IHZvaWQ+ID0gbnVsbCxcbiAgZGVidWdMYWJlbDogZmFsc2UgfCBzdHJpbmcgPSAndW5rbm93bidcbik6IFJlZmVyZW5jZTxUPiB7XG4gIGxldCByZWYgPSBuZXcgUmVmZXJlbmNlSW1wbDxUPihSZWZlcmVuY2VUeXBlLkNvbXB1dGUpO1xuXG4gIHJlZi5jb21wdXRlID0gY29tcHV0ZTtcbiAgcmVmLnVwZGF0ZSA9IHVwZGF0ZTtcblxuICBpZiAoREVCVUcpIHtcbiAgICByZWYuZGVidWdMYWJlbCA9IGAocmVzdWx0IG9mIGEgXFxgJHtkZWJ1Z0xhYmVsfVxcYCBoZWxwZXIpYDtcbiAgfVxuXG4gIHJldHVybiByZWY7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZWFkT25seVJlZihyZWY6IFJlZmVyZW5jZSk6IFJlZmVyZW5jZSB7XG4gIGlmICghaXNVcGRhdGFibGVSZWYocmVmKSkgcmV0dXJuIHJlZjtcblxuICByZXR1cm4gY3JlYXRlQ29tcHV0ZVJlZigoKSA9PiB2YWx1ZUZvclJlZihyZWYpLCBudWxsLCByZWYuZGVidWdMYWJlbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ludm9rYWJsZVJlZihyZWY6IFJlZmVyZW5jZSkge1xuICByZXR1cm4gcmVmW1JFRkVSRU5DRV0gPT09IFJlZmVyZW5jZVR5cGUuSW52b2thYmxlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlSW52b2thYmxlUmVmKGlubmVyOiBSZWZlcmVuY2UpOiBSZWZlcmVuY2Uge1xuICBsZXQgcmVmID0gY3JlYXRlQ29tcHV0ZVJlZihcbiAgICAoKSA9PiB2YWx1ZUZvclJlZihpbm5lciksXG4gICAgKHZhbHVlKSA9PiB1cGRhdGVSZWYoaW5uZXIsIHZhbHVlKVxuICApO1xuICByZWYuZGVidWdMYWJlbCA9IGlubmVyLmRlYnVnTGFiZWw7XG4gIHJlZltSRUZFUkVOQ0VdID0gUmVmZXJlbmNlVHlwZS5JbnZva2FibGU7XG5cbiAgcmV0dXJuIHJlZjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29uc3RSZWYoX3JlZjogUmVmZXJlbmNlKSB7XG4gIGxldCByZWYgPSBfcmVmIGFzIFJlZmVyZW5jZUltcGw7XG5cbiAgcmV0dXJuIHJlZi50YWcgPT09IENPTlNUQU5UX1RBRztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzVXBkYXRhYmxlUmVmKF9yZWY6IFJlZmVyZW5jZSkge1xuICBsZXQgcmVmID0gX3JlZiBhcyBSZWZlcmVuY2VJbXBsO1xuXG4gIHJldHVybiByZWYudXBkYXRlICE9PSBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsdWVGb3JSZWY8VD4oX3JlZjogUmVmZXJlbmNlPFQ+KTogVCB7XG4gIGxldCByZWYgPSBfcmVmIGFzIFJlZmVyZW5jZUltcGw8VD47XG5cbiAgbGV0IHsgdGFnIH0gPSByZWY7XG5cbiAgaWYgKHRhZyA9PT0gQ09OU1RBTlRfVEFHKSB7XG4gICAgcmV0dXJuIHJlZi5sYXN0VmFsdWUgYXMgVDtcbiAgfVxuXG4gIGxldCB7IGxhc3RSZXZpc2lvbiB9ID0gcmVmO1xuICBsZXQgbGFzdFZhbHVlO1xuXG4gIGlmICh0YWcgPT09IG51bGwgfHwgIXZhbGlkYXRlVGFnKHRhZywgbGFzdFJldmlzaW9uKSkge1xuICAgIGxldCB7IGNvbXB1dGUgfSA9IHJlZjtcblxuICAgIHRhZyA9IHJlZi50YWcgPSB0cmFjaygoKSA9PiB7XG4gICAgICBsYXN0VmFsdWUgPSByZWYubGFzdFZhbHVlID0gY29tcHV0ZSEoKTtcbiAgICB9LCBERUJVRyAmJiByZWYuZGVidWdMYWJlbCk7XG5cbiAgICByZWYubGFzdFJldmlzaW9uID0gdmFsdWVGb3JUYWcodGFnKTtcbiAgfSBlbHNlIHtcbiAgICBsYXN0VmFsdWUgPSByZWYubGFzdFZhbHVlO1xuICB9XG5cbiAgY29uc3VtZVRhZyh0YWcpO1xuXG4gIHJldHVybiBsYXN0VmFsdWUgYXMgVDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVJlZihfcmVmOiBSZWZlcmVuY2UsIHZhbHVlOiB1bmtub3duKSB7XG4gIGxldCByZWYgPSBfcmVmIGFzIFJlZmVyZW5jZUltcGw7XG5cbiAgbGV0IHVwZGF0ZSA9IGV4cGVjdChyZWYudXBkYXRlLCAnY2FsbGVkIHVwZGF0ZSBvbiBhIG5vbi11cGRhdGFibGUgcmVmZXJlbmNlJyk7XG5cbiAgdXBkYXRlKHZhbHVlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoaWxkUmVmRm9yKF9wYXJlbnRSZWY6IFJlZmVyZW5jZSwgcGF0aDogc3RyaW5nKTogUmVmZXJlbmNlIHtcbiAgbGV0IHBhcmVudFJlZiA9IF9wYXJlbnRSZWYgYXMgUmVmZXJlbmNlSW1wbDtcblxuICBsZXQgdHlwZSA9IHBhcmVudFJlZltSRUZFUkVOQ0VdO1xuXG4gIGxldCBjaGlsZHJlbiA9IHBhcmVudFJlZi5jaGlsZHJlbjtcbiAgbGV0IGNoaWxkOiBSZWZlcmVuY2U7XG5cbiAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7XG4gICAgY2hpbGRyZW4gPSBwYXJlbnRSZWYuY2hpbGRyZW4gPSBuZXcgTWFwKCk7XG4gIH0gZWxzZSB7XG4gICAgY2hpbGQgPSBjaGlsZHJlbi5nZXQocGF0aCkhO1xuXG4gICAgaWYgKGNoaWxkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBjaGlsZDtcbiAgICB9XG4gIH1cblxuICBpZiAodHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5VbmJvdW5kKSB7XG4gICAgbGV0IHBhcmVudCA9IHZhbHVlRm9yUmVmKHBhcmVudFJlZik7XG5cbiAgICBpZiAoaXNEaWN0KHBhcmVudCkpIHtcbiAgICAgIGNoaWxkID0gY3JlYXRlVW5ib3VuZFJlZihcbiAgICAgICAgKHBhcmVudCBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilbcGF0aF0sXG4gICAgICAgIERFQlVHICYmIGAke3BhcmVudFJlZi5kZWJ1Z0xhYmVsfS4ke3BhdGh9YFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2hpbGQgPSBVTkRFRklORURfUkVGRVJFTkNFO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBjaGlsZCA9IGNyZWF0ZUNvbXB1dGVSZWYoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIGxldCBwYXJlbnQgPSB2YWx1ZUZvclJlZihwYXJlbnRSZWYpO1xuXG4gICAgICAgIGlmIChpc0RpY3QocGFyZW50KSkge1xuICAgICAgICAgIHJldHVybiBnZXRQcm9wKHBhcmVudCwgcGF0aCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICAodmFsKSA9PiB7XG4gICAgICAgIGxldCBwYXJlbnQgPSB2YWx1ZUZvclJlZihwYXJlbnRSZWYpO1xuXG4gICAgICAgIGlmIChpc0RpY3QocGFyZW50KSkge1xuICAgICAgICAgIHJldHVybiBzZXRQcm9wKHBhcmVudCwgcGF0aCwgdmFsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG5cbiAgICBpZiAoREVCVUcpIHtcbiAgICAgIGNoaWxkLmRlYnVnTGFiZWwgPSBgJHtwYXJlbnRSZWYuZGVidWdMYWJlbH0uJHtwYXRofWA7XG4gICAgfVxuICB9XG5cbiAgY2hpbGRyZW4uc2V0KHBhdGgsIGNoaWxkKTtcblxuICByZXR1cm4gY2hpbGQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGlsZFJlZkZyb21QYXJ0cyhyb290OiBSZWZlcmVuY2UsIHBhcnRzOiBzdHJpbmdbXSk6IFJlZmVyZW5jZSB7XG4gIGxldCByZWZlcmVuY2UgPSByb290O1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICByZWZlcmVuY2UgPSBjaGlsZFJlZkZvcihyZWZlcmVuY2UsIHBhcnRzW2ldKTtcbiAgfVxuXG4gIHJldHVybiByZWZlcmVuY2U7XG59XG5cbmV4cG9ydCBsZXQgY3JlYXRlRGVidWdBbGlhc1JlZjogdW5kZWZpbmVkIHwgKChkZWJ1Z0xhYmVsOiBzdHJpbmcsIGlubmVyOiBSZWZlcmVuY2UpID0+IFJlZmVyZW5jZSk7XG5cbmlmIChERUJVRykge1xuICBjcmVhdGVEZWJ1Z0FsaWFzUmVmID0gKGRlYnVnTGFiZWw6IHN0cmluZywgaW5uZXI6IFJlZmVyZW5jZSkgPT4ge1xuICAgIGxldCB1cGRhdGUgPSBpc1VwZGF0YWJsZVJlZihpbm5lcikgPyAodmFsdWU6IHVua25vd24pID0+IHVwZGF0ZVJlZihpbm5lciwgdmFsdWUpIDogbnVsbDtcbiAgICBsZXQgcmVmID0gY3JlYXRlQ29tcHV0ZVJlZigoKSA9PiB2YWx1ZUZvclJlZihpbm5lciksIHVwZGF0ZSk7XG5cbiAgICByZWZbUkVGRVJFTkNFXSA9IGlubmVyW1JFRkVSRU5DRV07XG5cbiAgICByZWYuZGVidWdMYWJlbCA9IGRlYnVnTGFiZWw7XG5cbiAgICByZXR1cm4gcmVmO1xuICB9O1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==