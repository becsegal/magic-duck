import { DEBUG } from '@glimmer/env';
import { getProp, setProp } from '@glimmer/global-context';
import { isDict, symbol } from '@glimmer/util';
import { CONSTANT_TAG, consumeTag, INITIAL, track, validateTag, valueForTag } from '@glimmer/validator';
export const REFERENCE = symbol('REFERENCE');

class ReferenceImpl {
  constructor(type) {
    this.tag = null;
    this.lastRevision = INITIAL;
    this.children = null;
    this.compute = null;
    this.update = null;
    this[REFERENCE] = type;
  }

}

export function createPrimitiveRef(value) {
  let ref = new ReferenceImpl(2
  /* Unbound */
  );
  ref.tag = CONSTANT_TAG;
  ref.lastValue = value;

  if (DEBUG) {
    ref.debugLabel = String(value);
  }

  return ref;
}
export const UNDEFINED_REFERENCE = createPrimitiveRef(undefined);
export const NULL_REFERENCE = createPrimitiveRef(null);
export const TRUE_REFERENCE = createPrimitiveRef(true);
export const FALSE_REFERENCE = createPrimitiveRef(false);
export function createConstRef(value, debugLabel) {
  let ref = new ReferenceImpl(0
  /* Constant */
  );
  ref.lastValue = value;
  ref.tag = CONSTANT_TAG;

  if (DEBUG) {
    ref.debugLabel = debugLabel;
  }

  return ref;
}
export function createUnboundRef(value, debugLabel) {
  let ref = new ReferenceImpl(2
  /* Unbound */
  );
  ref.lastValue = value;
  ref.tag = CONSTANT_TAG;

  if (DEBUG) {
    ref.debugLabel = debugLabel;
  }

  return ref;
}
export function createComputeRef(compute, update = null, debugLabel = 'unknown') {
  let ref = new ReferenceImpl(1
  /* Compute */
  );
  ref.compute = compute;
  ref.update = update;

  if (DEBUG) {
    ref.debugLabel = `(result of a \`${debugLabel}\` helper)`;
  }

  return ref;
}
export function createReadOnlyRef(ref) {
  if (!isUpdatableRef(ref)) return ref;
  return createComputeRef(() => valueForRef(ref), null, ref.debugLabel);
}
export function isInvokableRef(ref) {
  return ref[REFERENCE] === 3
  /* Invokable */
  ;
}
export function createInvokableRef(inner) {
  let ref = createComputeRef(() => valueForRef(inner), value => updateRef(inner, value));
  ref.debugLabel = inner.debugLabel;
  ref[REFERENCE] = 3
  /* Invokable */
  ;
  return ref;
}
export function isConstRef(_ref) {
  let ref = _ref;
  return ref.tag === CONSTANT_TAG;
}
export function isUpdatableRef(_ref) {
  let ref = _ref;
  return ref.update !== null;
}
export function valueForRef(_ref) {
  let ref = _ref;
  let {
    tag
  } = ref;

  if (tag === CONSTANT_TAG) {
    return ref.lastValue;
  }

  let {
    lastRevision
  } = ref;
  let lastValue;

  if (tag === null || !validateTag(tag, lastRevision)) {
    let {
      compute
    } = ref;
    tag = ref.tag = track(() => {
      lastValue = ref.lastValue = compute();
    }, DEBUG && ref.debugLabel);
    ref.lastRevision = valueForTag(tag);
  } else {
    lastValue = ref.lastValue;
  }

  consumeTag(tag);
  return lastValue;
}
export function updateRef(_ref, value) {
  let ref = _ref;
  let update = ref.update;
  update(value);
}
export function childRefFor(_parentRef, path) {
  let parentRef = _parentRef;
  let type = parentRef[REFERENCE];
  let children = parentRef.children;
  let child;

  if (children === null) {
    children = parentRef.children = new Map();
  } else {
    child = children.get(path);

    if (child !== undefined) {
      return child;
    }
  }

  if (type === 2
  /* Unbound */
  ) {
      let parent = valueForRef(parentRef);

      if (isDict(parent)) {
        child = createUnboundRef(parent[path], DEBUG && `${parentRef.debugLabel}.${path}`);
      } else {
        child = UNDEFINED_REFERENCE;
      }
    } else {
    child = createComputeRef(() => {
      let parent = valueForRef(parentRef);

      if (isDict(parent)) {
        return getProp(parent, path);
      }
    }, val => {
      let parent = valueForRef(parentRef);

      if (isDict(parent)) {
        return setProp(parent, path, val);
      }
    });

    if (DEBUG) {
      child.debugLabel = `${parentRef.debugLabel}.${path}`;
    }
  }

  children.set(path, child);
  return child;
}
export function childRefFromParts(root, parts) {
  let reference = root;

  for (let i = 0; i < parts.length; i++) {
    reference = childRefFor(reference, parts[i]);
  }

  return reference;
}
export let createDebugAliasRef;

if (DEBUG) {
  createDebugAliasRef = (debugLabel, inner) => {
    let update = isUpdatableRef(inner) ? value => updateRef(inner, value) : null;
    let ref = createComputeRef(() => valueForRef(inner), update);
    ref[REFERENCE] = inner[REFERENCE];
    ref.debugLabel = debugLabel;
    return ref;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3JlZmVyZW5jZS9saWIvcmVmZXJlbmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsS0FBVCxRQUFzQixjQUF0QjtBQUNBLFNBQVMsT0FBVCxFQUFrQixPQUFsQixRQUFpQyx5QkFBakM7QUFFQSxTQUFpQixNQUFqQixFQUF5QixNQUF6QixRQUF1QyxlQUF2QztBQUNBLFNBQ0UsWUFERixFQUVFLFVBRkYsRUFHRSxPQUhGLEVBTUUsS0FORixFQU9FLFdBUEYsRUFRRSxXQVJGLFFBU08sb0JBVFA7QUFXQSxPQUFPLE1BQU0sU0FBUyxHQUFrQixNQUFNLENBQUMsV0FBRCxDQUF2Qzs7QUF3QlAsTUFBTSxhQUFOLENBQW1CO0FBYWpCLEVBQUEsV0FBQSxDQUFZLElBQVosRUFBK0I7QUFYeEIsU0FBQSxHQUFBLEdBQW1CLElBQW5CO0FBQ0EsU0FBQSxZQUFBLEdBQXlCLE9BQXpCO0FBR0EsU0FBQSxRQUFBLEdBQXVELElBQXZEO0FBRUEsU0FBQSxPQUFBLEdBQTJCLElBQTNCO0FBQ0EsU0FBQSxNQUFBLEdBQW1DLElBQW5DO0FBS0wsU0FBSyxTQUFMLElBQWtCLElBQWxCO0FBQ0Q7O0FBZmdCOztBQWtCbkIsT0FBTSxTQUFVLGtCQUFWLENBQTZCLEtBQTdCLEVBQTJDO0FBQy9DLE1BQUksR0FBRyxHQUFHLElBQUksYUFBSixDQUFpQjtBQUFBO0FBQWpCLEdBQVY7QUFFQSxFQUFBLEdBQUcsQ0FBQyxHQUFKLEdBQVUsWUFBVjtBQUNBLEVBQUEsR0FBRyxDQUFDLFNBQUosR0FBZ0IsS0FBaEI7O0FBRUEsTUFBSSxLQUFKLEVBQVc7QUFDVCxJQUFBLEdBQUcsQ0FBQyxVQUFKLEdBQWlCLE1BQU0sQ0FBQyxLQUFELENBQXZCO0FBQ0Q7O0FBRUQsU0FBTyxHQUFQO0FBQ0Q7QUFFRCxPQUFPLE1BQU0sbUJBQW1CLEdBQUcsa0JBQWtCLENBQUMsU0FBRCxDQUE5QztBQUNQLE9BQU8sTUFBTSxj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LEVBQUEsUUFBUSxDQUFDLEdBQVQsQ0FBYSxJQUFiLEVBQW1CLEtBQW5CO0FBRUEsU0FBTyxLQUFQO0FBQ0Q7QUFFRCxPQUFNLFNBQVUsaUJBQVYsQ0FBNEIsSUFBNUIsRUFBNkMsS0FBN0MsRUFBNEQ7QUFDaEUsTUFBSSxTQUFTLEdBQUcsSUFBaEI7O0FBRUEsT0FBSyxJQUFJLENBQUMsR0FBRyxDQUFiLEVBQWdCLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBMUIsRUFBa0MsQ0FBQyxFQUFuQyxFQUF1QztBQUNyQyxJQUFBLFNBQVMsR0FBRyxXQUFXLENBQUMsU0FBRCxFQUFZLEtBQUssQ0FBQyxDQUFELENBQWpCLENBQXZCO0FBQ0Q7O0FBRUQsU0FBTyxTQUFQO0FBQ0Q7QUFFRCxPQUFPLElBQUksbUJBQUo7O0FBRVAsSUFBSSxLQUFKLEVBQVc7QUFDVCxFQUFBLG1CQUFtQixHQUFHLENBQUMsVUFBRCxFQUFxQixLQUFyQixLQUF5QztBQUM3RCxRQUFJLE1BQU0sR0FBRyxjQUFjLENBQUMsS0FBRCxDQUFkLEdBQXlCLEtBQUQsSUFBb0IsU0FBUyxDQUFDLEtBQUQsRUFBUSxLQUFSLENBQXJELEdBQXNFLElBQW5GO0FBQ0EsUUFBSSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxXQUFXLENBQUMsS0FBRCxDQUFsQixFQUEyQixNQUEzQixDQUExQjtBQUVBLElBQUEsR0FBRyxDQUFDLFNBQUQsQ0FBSCxHQUFpQixLQUFLLENBQUMsU0FBRCxDQUF0QjtBQUVBLElBQUEsR0FBRyxDQUFDLFVBQUosR0FBaUIsVUFBakI7QUFFQSxXQUFPLEdBQVA7QUFDRCxHQVREO0FBVUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBERUJVRyB9IGZyb20gJ0BnbGltbWVyL2Vudic7XG5pbXBvcnQgeyBnZXRQcm9wLCBzZXRQcm9wIH0gZnJvbSAnQGdsaW1tZXIvZ2xvYmFsLWNvbnRleHQnO1xuaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBleHBlY3QsIGlzRGljdCwgc3ltYm9sIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQge1xuICBDT05TVEFOVF9UQUcsXG4gIGNvbnN1bWVUYWcsXG4gIElOSVRJQUwsXG4gIFJldmlzaW9uLFxuICBUYWcsXG4gIHRyYWNrLFxuICB2YWxpZGF0ZVRhZyxcbiAgdmFsdWVGb3JUYWcsXG59IGZyb20gJ0BnbGltbWVyL3ZhbGlkYXRvcic7XG5cbmV4cG9ydCBjb25zdCBSRUZFUkVOQ0U6IHVuaXF1ZSBzeW1ib2wgPSBzeW1ib2woJ1JFRkVSRU5DRScpO1xuXG5jb25zdCBlbnVtIFJlZmVyZW5jZVR5cGUge1xuICBDb25zdGFudCxcbiAgQ29tcHV0ZSxcbiAgVW5ib3VuZCxcbiAgSW52b2thYmxlLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlZmVyZW5jZTxfVCA9IHVua25vd24+IHtcbiAgW1JFRkVSRU5DRV06IFJlZmVyZW5jZVR5cGU7XG4gIGRlYnVnTGFiZWw/OiBzdHJpbmc7XG4gIGNoaWxkcmVuOiBudWxsIHwgTWFwPHN0cmluZyB8IFJlZmVyZW5jZSwgUmVmZXJlbmNlPjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgUmVmZXJlbmNlO1xuXG4vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVmZXJlbmNlRW52aXJvbm1lbnQge1xuICBnZXRQcm9wKG9iajogdW5rbm93biwgcGF0aDogc3RyaW5nKTogdW5rbm93bjtcbiAgc2V0UHJvcChvYmo6IHVua25vd24sIHBhdGg6IHN0cmluZywgdmFsdWU6IHVua25vd24pOiB1bmtub3duO1xufVxuXG5jbGFzcyBSZWZlcmVuY2VJbXBsPFQgPSB1bmtub3duPiBpbXBsZW1lbnRzIFJlZmVyZW5jZSB7XG4gIFtSRUZFUkVOQ0VdOiBSZWZlcmVuY2VUeXBlO1xuICBwdWJsaWMgdGFnOiBPcHRpb248VGFnPiA9IG51bGw7XG4gIHB1YmxpYyBsYXN0UmV2aXNpb246IFJldmlzaW9uID0gSU5JVElBTDtcbiAgcHVibGljIGxhc3RWYWx1ZT86IFQ7XG5cbiAgcHVibGljIGNoaWxkcmVuOiBPcHRpb248TWFwPHN0cmluZyB8IFJlZmVyZW5jZSwgUmVmZXJlbmNlPj4gPSBudWxsO1xuXG4gIHB1YmxpYyBjb21wdXRlOiBPcHRpb248KCkgPT4gVD4gPSBudWxsO1xuICBwdWJsaWMgdXBkYXRlOiBPcHRpb248KHZhbDogVCkgPT4gdm9pZD4gPSBudWxsO1xuXG4gIHB1YmxpYyBkZWJ1Z0xhYmVsPzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHR5cGU6IFJlZmVyZW5jZVR5cGUpIHtcbiAgICB0aGlzW1JFRkVSRU5DRV0gPSB0eXBlO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVQcmltaXRpdmVSZWYodmFsdWU6IHVua25vd24pOiBSZWZlcmVuY2Uge1xuICBsZXQgcmVmID0gbmV3IFJlZmVyZW5jZUltcGwoUmVmZXJlbmNlVHlwZS5VbmJvdW5kKTtcblxuICByZWYudGFnID0gQ09OU1RBTlRfVEFHO1xuICByZWYubGFzdFZhbHVlID0gdmFsdWU7XG5cbiAgaWYgKERFQlVHKSB7XG4gICAgcmVmLmRlYnVnTGFiZWwgPSBTdHJpbmcodmFsdWUpO1xuICB9XG5cbiAgcmV0dXJuIHJlZjtcbn1cblxuZXhwb3J0IGNvbnN0IFVOREVGSU5FRF9SRUZFUkVOQ0UgPSBjcmVhdGVQcmltaXRpdmVSZWYodW5kZWZpbmVkKTtcbmV4cG9ydCBjb25zdCBOVUxMX1JFRkVSRU5DRSA9IGNyZWF0ZVByaW1pdGl2ZVJlZihudWxsKTtcbmV4cG9ydCBjb25zdCBUUlVFX1JFRkVSRU5DRSA9IGNyZWF0ZVByaW1pdGl2ZVJlZih0cnVlKTtcbmV4cG9ydCBjb25zdCBGQUxTRV9SRUZFUkVOQ0UgPSBjcmVhdGVQcmltaXRpdmVSZWYoZmFsc2UpO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ29uc3RSZWYodmFsdWU6IHVua25vd24sIGRlYnVnTGFiZWw6IGZhbHNlIHwgc3RyaW5nKTogUmVmZXJlbmNlIHtcbiAgbGV0IHJlZiA9IG5ldyBSZWZlcmVuY2VJbXBsKFJlZmVyZW5jZVR5cGUuQ29uc3RhbnQpO1xuXG4gIHJlZi5sYXN0VmFsdWUgPSB2YWx1ZTtcbiAgcmVmLnRhZyA9IENPTlNUQU5UX1RBRztcblxuICBpZiAoREVCVUcpIHtcbiAgICByZWYuZGVidWdMYWJlbCA9IGRlYnVnTGFiZWwgYXMgc3RyaW5nO1xuICB9XG5cbiAgcmV0dXJuIHJlZjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVVuYm91bmRSZWYodmFsdWU6IHVua25vd24sIGRlYnVnTGFiZWw6IGZhbHNlIHwgc3RyaW5nKTogUmVmZXJlbmNlIHtcbiAgbGV0IHJlZiA9IG5ldyBSZWZlcmVuY2VJbXBsKFJlZmVyZW5jZVR5cGUuVW5ib3VuZCk7XG5cbiAgcmVmLmxhc3RWYWx1ZSA9IHZhbHVlO1xuICByZWYudGFnID0gQ09OU1RBTlRfVEFHO1xuXG4gIGlmIChERUJVRykge1xuICAgIHJlZi5kZWJ1Z0xhYmVsID0gZGVidWdMYWJlbCBhcyBzdHJpbmc7XG4gIH1cblxuICByZXR1cm4gcmVmO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ29tcHV0ZVJlZjxUID0gdW5rbm93bj4oXG4gIGNvbXB1dGU6ICgpID0+IFQsXG4gIHVwZGF0ZTogT3B0aW9uPCh2YWx1ZTogVCkgPT4gdm9pZD4gPSBudWxsLFxuICBkZWJ1Z0xhYmVsOiBmYWxzZSB8IHN0cmluZyA9ICd1bmtub3duJ1xuKTogUmVmZXJlbmNlPFQ+IHtcbiAgbGV0IHJlZiA9IG5ldyBSZWZlcmVuY2VJbXBsPFQ+KFJlZmVyZW5jZVR5cGUuQ29tcHV0ZSk7XG5cbiAgcmVmLmNvbXB1dGUgPSBjb21wdXRlO1xuICByZWYudXBkYXRlID0gdXBkYXRlO1xuXG4gIGlmIChERUJVRykge1xuICAgIHJlZi5kZWJ1Z0xhYmVsID0gYChyZXN1bHQgb2YgYSBcXGAke2RlYnVnTGFiZWx9XFxgIGhlbHBlcilgO1xuICB9XG5cbiAgcmV0dXJuIHJlZjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlYWRPbmx5UmVmKHJlZjogUmVmZXJlbmNlKTogUmVmZXJlbmNlIHtcbiAgaWYgKCFpc1VwZGF0YWJsZVJlZihyZWYpKSByZXR1cm4gcmVmO1xuXG4gIHJldHVybiBjcmVhdGVDb21wdXRlUmVmKCgpID0+IHZhbHVlRm9yUmVmKHJlZiksIG51bGwsIHJlZi5kZWJ1Z0xhYmVsKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzSW52b2thYmxlUmVmKHJlZjogUmVmZXJlbmNlKSB7XG4gIHJldHVybiByZWZbUkVGRVJFTkNFXSA9PT0gUmVmZXJlbmNlVHlwZS5JbnZva2FibGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJbnZva2FibGVSZWYoaW5uZXI6IFJlZmVyZW5jZSk6IFJlZmVyZW5jZSB7XG4gIGxldCByZWYgPSBjcmVhdGVDb21wdXRlUmVmKFxuICAgICgpID0+IHZhbHVlRm9yUmVmKGlubmVyKSxcbiAgICAodmFsdWUpID0+IHVwZGF0ZVJlZihpbm5lciwgdmFsdWUpXG4gICk7XG4gIHJlZi5kZWJ1Z0xhYmVsID0gaW5uZXIuZGVidWdMYWJlbDtcbiAgcmVmW1JFRkVSRU5DRV0gPSBSZWZlcmVuY2VUeXBlLkludm9rYWJsZTtcblxuICByZXR1cm4gcmVmO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNDb25zdFJlZihfcmVmOiBSZWZlcmVuY2UpIHtcbiAgbGV0IHJlZiA9IF9yZWYgYXMgUmVmZXJlbmNlSW1wbDtcblxuICByZXR1cm4gcmVmLnRhZyA9PT0gQ09OU1RBTlRfVEFHO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNVcGRhdGFibGVSZWYoX3JlZjogUmVmZXJlbmNlKSB7XG4gIGxldCByZWYgPSBfcmVmIGFzIFJlZmVyZW5jZUltcGw7XG5cbiAgcmV0dXJuIHJlZi51cGRhdGUgIT09IG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWx1ZUZvclJlZjxUPihfcmVmOiBSZWZlcmVuY2U8VD4pOiBUIHtcbiAgbGV0IHJlZiA9IF9yZWYgYXMgUmVmZXJlbmNlSW1wbDxUPjtcblxuICBsZXQgeyB0YWcgfSA9IHJlZjtcblxuICBpZiAodGFnID09PSBDT05TVEFOVF9UQUcpIHtcbiAgICByZXR1cm4gcmVmLmxhc3RWYWx1ZSBhcyBUO1xuICB9XG5cbiAgbGV0IHsgbGFzdFJldmlzaW9uIH0gPSByZWY7XG4gIGxldCBsYXN0VmFsdWU7XG5cbiAgaWYgKHRhZyA9PT0gbnVsbCB8fCAhdmFsaWRhdGVUYWcodGFnLCBsYXN0UmV2aXNpb24pKSB7XG4gICAgbGV0IHsgY29tcHV0ZSB9ID0gcmVmO1xuXG4gICAgdGFnID0gcmVmLnRhZyA9IHRyYWNrKCgpID0+IHtcbiAgICAgIGxhc3RWYWx1ZSA9IHJlZi5sYXN0VmFsdWUgPSBjb21wdXRlISgpO1xuICAgIH0sIERFQlVHICYmIHJlZi5kZWJ1Z0xhYmVsKTtcblxuICAgIHJlZi5sYXN0UmV2aXNpb24gPSB2YWx1ZUZvclRhZyh0YWcpO1xuICB9IGVsc2Uge1xuICAgIGxhc3RWYWx1ZSA9IHJlZi5sYXN0VmFsdWU7XG4gIH1cblxuICBjb25zdW1lVGFnKHRhZyk7XG5cbiAgcmV0dXJuIGxhc3RWYWx1ZSBhcyBUO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlUmVmKF9yZWY6IFJlZmVyZW5jZSwgdmFsdWU6IHVua25vd24pIHtcbiAgbGV0IHJlZiA9IF9yZWYgYXMgUmVmZXJlbmNlSW1wbDtcblxuICBsZXQgdXBkYXRlID0gZXhwZWN0KHJlZi51cGRhdGUsICdjYWxsZWQgdXBkYXRlIG9uIGEgbm9uLXVwZGF0YWJsZSByZWZlcmVuY2UnKTtcblxuICB1cGRhdGUodmFsdWUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hpbGRSZWZGb3IoX3BhcmVudFJlZjogUmVmZXJlbmNlLCBwYXRoOiBzdHJpbmcpOiBSZWZlcmVuY2Uge1xuICBsZXQgcGFyZW50UmVmID0gX3BhcmVudFJlZiBhcyBSZWZlcmVuY2VJbXBsO1xuXG4gIGxldCB0eXBlID0gcGFyZW50UmVmW1JFRkVSRU5DRV07XG5cbiAgbGV0IGNoaWxkcmVuID0gcGFyZW50UmVmLmNoaWxkcmVuO1xuICBsZXQgY2hpbGQ6IFJlZmVyZW5jZTtcblxuICBpZiAoY2hpbGRyZW4gPT09IG51bGwpIHtcbiAgICBjaGlsZHJlbiA9IHBhcmVudFJlZi5jaGlsZHJlbiA9IG5ldyBNYXAoKTtcbiAgfSBlbHNlIHtcbiAgICBjaGlsZCA9IGNoaWxkcmVuLmdldChwYXRoKSE7XG5cbiAgICBpZiAoY2hpbGQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGNoaWxkO1xuICAgIH1cbiAgfVxuXG4gIGlmICh0eXBlID09PSBSZWZlcmVuY2VUeXBlLlVuYm91bmQpIHtcbiAgICBsZXQgcGFyZW50ID0gdmFsdWVGb3JSZWYocGFyZW50UmVmKTtcblxuICAgIGlmIChpc0RpY3QocGFyZW50KSkge1xuICAgICAgY2hpbGQgPSBjcmVhdGVVbmJvdW5kUmVmKFxuICAgICAgICAocGFyZW50IGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVtwYXRoXSxcbiAgICAgICAgREVCVUcgJiYgYCR7cGFyZW50UmVmLmRlYnVnTGFiZWx9LiR7cGF0aH1gXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjaGlsZCA9IFVOREVGSU5FRF9SRUZFUkVOQ0U7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNoaWxkID0gY3JlYXRlQ29tcHV0ZVJlZihcbiAgICAgICgpID0+IHtcbiAgICAgICAgbGV0IHBhcmVudCA9IHZhbHVlRm9yUmVmKHBhcmVudFJlZik7XG5cbiAgICAgICAgaWYgKGlzRGljdChwYXJlbnQpKSB7XG4gICAgICAgICAgcmV0dXJuIGdldFByb3AocGFyZW50LCBwYXRoKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgICh2YWwpID0+IHtcbiAgICAgICAgbGV0IHBhcmVudCA9IHZhbHVlRm9yUmVmKHBhcmVudFJlZik7XG5cbiAgICAgICAgaWYgKGlzRGljdChwYXJlbnQpKSB7XG4gICAgICAgICAgcmV0dXJuIHNldFByb3AocGFyZW50LCBwYXRoLCB2YWwpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcblxuICAgIGlmIChERUJVRykge1xuICAgICAgY2hpbGQuZGVidWdMYWJlbCA9IGAke3BhcmVudFJlZi5kZWJ1Z0xhYmVsfS4ke3BhdGh9YDtcbiAgICB9XG4gIH1cblxuICBjaGlsZHJlbi5zZXQocGF0aCwgY2hpbGQpO1xuXG4gIHJldHVybiBjaGlsZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoaWxkUmVmRnJvbVBhcnRzKHJvb3Q6IFJlZmVyZW5jZSwgcGFydHM6IHN0cmluZ1tdKTogUmVmZXJlbmNlIHtcbiAgbGV0IHJlZmVyZW5jZSA9IHJvb3Q7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgIHJlZmVyZW5jZSA9IGNoaWxkUmVmRm9yKHJlZmVyZW5jZSwgcGFydHNbaV0pO1xuICB9XG5cbiAgcmV0dXJuIHJlZmVyZW5jZTtcbn1cblxuZXhwb3J0IGxldCBjcmVhdGVEZWJ1Z0FsaWFzUmVmOiB1bmRlZmluZWQgfCAoKGRlYnVnTGFiZWw6IHN0cmluZywgaW5uZXI6IFJlZmVyZW5jZSkgPT4gUmVmZXJlbmNlKTtcblxuaWYgKERFQlVHKSB7XG4gIGNyZWF0ZURlYnVnQWxpYXNSZWYgPSAoZGVidWdMYWJlbDogc3RyaW5nLCBpbm5lcjogUmVmZXJlbmNlKSA9PiB7XG4gICAgbGV0IHVwZGF0ZSA9IGlzVXBkYXRhYmxlUmVmKGlubmVyKSA/ICh2YWx1ZTogdW5rbm93bikgPT4gdXBkYXRlUmVmKGlubmVyLCB2YWx1ZSkgOiBudWxsO1xuICAgIGxldCByZWYgPSBjcmVhdGVDb21wdXRlUmVmKCgpID0+IHZhbHVlRm9yUmVmKGlubmVyKSwgdXBkYXRlKTtcblxuICAgIHJlZltSRUZFUkVOQ0VdID0gaW5uZXJbUkVGRVJFTkNFXTtcblxuICAgIHJlZi5kZWJ1Z0xhYmVsID0gZGVidWdMYWJlbDtcblxuICAgIHJldHVybiByZWY7XG4gIH07XG59XG4iXSwic291cmNlUm9vdCI6IiJ9